# Async Agent - Docker Deployment Guide

This guide explains how to deploy the Async Agent using Docker and Docker Compose for a production-ready, containerized setup.

## Quick Start

### Prerequisites

- Docker 20.10+ ([Install Docker](https://docs.docker.com/get-docker/))
- Docker Compose 2.0+ (included with Docker Desktop)
- Anthropic API key ([Get one here](https://console.anthropic.com/))

### 1. Clone and Configure

```bash
# Clone the repository (if not already cloned)
git clone <your-repo-url>
cd async-agent

# Copy the Docker environment template
cp .env.docker.example .env

# Edit .env and set your ANTHROPIC_API_KEY
nano .env  # or use your preferred editor
```

**Minimum required configuration in `.env`:**
```bash
ANTHROPIC_API_KEY=sk-ant-your-actual-api-key-here
POSTGRES_PASSWORD=your-secure-password-here
```

### 2. Start the Services

```bash
# Build and start all services (app + PostgreSQL)
docker-compose up -d

# View logs
docker-compose logs -f

# Check health status
docker-compose ps
```

### 3. Test the Deployment

```bash
# Health check
curl http://localhost:3001/health

# Test the agent
curl -X POST http://localhost:3001/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "What is 2+2? Explain your reasoning.",
    "requestId": "test-123"
  }'
```

**Expected response:**
```json
{
  "response": "2+2 equals 4...",
  "files": [],
  "requestId": "test-123",
  "trace": [...]
}
```

---

## Architecture

The Docker setup consists of two services:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  async-agent-app                    â”‚
â”‚  (Node.js + TypeScript)             â”‚
â”‚  Port: 3001                         â”‚
â”‚  â€¢ Runs agent execution             â”‚
â”‚  â€¢ Stores files locally             â”‚
â”‚  â€¢ Connects to PostgreSQL           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  async-agent-db                     â”‚
â”‚  (PostgreSQL 15)                    â”‚
â”‚  Port: 5432                         â”‚
â”‚  â€¢ Stores Skills & Connections      â”‚
â”‚  â€¢ Encrypted credentials            â”‚
â”‚  â€¢ Execution history                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Persistent Data

The following data is persisted across container restarts:

1. **PostgreSQL Database** â†’ `postgres_data` volume
   - All skills, connections, executions
   - Encrypted credentials

2. **Uploaded Files** â†’ `file_storage` volume
   - Files generated by the agent
   - Accessible at `http://localhost:3001/files/...`

---

## Configuration

### Environment Variables

All configuration is done via `.env` file. See `.env.docker.example` for all available options.

#### Essential Settings

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `ANTHROPIC_API_KEY` | **Yes** | - | Claude API key |
| `POSTGRES_PASSWORD` | **Yes** | `changeme123` | Database password |
| `PORT` | No | `3001` | Host port to expose |

#### Agent Configuration

| Variable | Default | Description |
|----------|---------|-------------|
| `AGENT_MODEL` | `claude-sonnet-4-20250514` | Main agent model |
| `WORKFLOW_AGENT_MODEL` | `claude-3-5-haiku-20241022` | Workflow step model |
| `CLASSIFIER_MODEL` | `claude-3-5-haiku-20241022` | Workflow classifier model |
| `AGENT_TIMEOUT_MS` | `300000` (5 min) | Agent execution timeout |

#### MCP Connections

Configure MCP servers via `MCP_CONNECTIONS` environment variable:

```bash
# In .env file:
MCP_CONNECTIONS={"filesystem":{"command":"npx","args":["-y","@modelcontextprotocol/server-filesystem","/workspace"]}}
```

Or for complex configs, create a separate JSON file and mount it as a volume.

---

## Management Commands

### Starting and Stopping

```bash
# Start services
docker-compose up -d

# Stop services (keeps data)
docker-compose stop

# Stop and remove containers (keeps data in volumes)
docker-compose down

# Stop and remove EVERYTHING including data
docker-compose down -v
```

### Viewing Logs

```bash
# All services
docker-compose logs -f

# Just the app
docker-compose logs -f app

# Just the database
docker-compose logs -f postgres

# Last 100 lines
docker-compose logs --tail=100 app
```

### Rebuilding After Code Changes

```bash
# Rebuild the app container
docker-compose build app

# Rebuild and restart
docker-compose up -d --build app
```

### Database Management

```bash
# Access PostgreSQL shell
docker-compose exec postgres psql -U asyncagent -d async_agent

# Run Prisma migrations manually
docker-compose exec app npx prisma migrate deploy

# View migration status
docker-compose exec app npx prisma migrate status

# Access Prisma Studio (database GUI)
docker-compose exec app npx prisma studio
```

### File Storage

```bash
# View stored files
docker-compose exec app ls -la /app/storage/files/

# Access a specific request's files
docker-compose exec app ls -la /app/storage/files/req-1234567890/

# Copy files from container to host
docker cp async-agent-app:/app/storage/files ./local-files
```

---

## Endpoints

Once running, the following endpoints are available:

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/webhook` | POST | Execute agent prompt |
| `/webhooks/prompt` | POST | Alias for `/webhook` |
| `/health` | GET | Health check |
| `/metrics` | GET | Performance metrics |
| `/files/:requestId/:filename` | GET | Retrieve uploaded files |

---

## Scaling and Performance

### Resource Limits

Add resource limits to `docker-compose.yml`:

```yaml
services:
  app:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
```

### Database Performance

For high-load scenarios, tune PostgreSQL:

```yaml
services:
  postgres:
    environment:
      POSTGRES_MAX_CONNECTIONS: 50
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 1GB
      POSTGRES_WORK_MEM: 16MB
```

### Multiple Instances

To run multiple agent instances:

1. Use a reverse proxy (nginx, Traefik)
2. Set up load balancing
3. Share the database and file storage volumes

---

## Troubleshooting

### Container Won't Start

```bash
# Check logs
docker-compose logs app

# Common issues:
# 1. ANTHROPIC_API_KEY not set
# 2. Database not ready (wait 30s)
# 3. Port 3001 already in use
```

### Database Connection Errors

```bash
# Verify database is running
docker-compose ps postgres

# Check database logs
docker-compose logs postgres

# Test connection
docker-compose exec postgres pg_isready -U asyncagent
```

### File Upload Errors

```bash
# Check storage directory permissions
docker-compose exec app ls -la /app/storage/

# Recreate storage volume
docker-compose down
docker volume rm async-agent_file_storage
docker-compose up -d
```

### Reset Everything

```bash
# Nuclear option: delete all data and restart
docker-compose down -v
docker-compose up -d --build
```

---

## Security Best Practices

### 1. Change Default Passwords

```bash
# Generate secure password
openssl rand -base64 32

# Update in .env
POSTGRES_PASSWORD=<generated-password>
```

### 2. Restrict Network Access

Add to `docker-compose.yml`:

```yaml
services:
  postgres:
    ports:
      - "127.0.0.1:5432:5432"  # Only localhost can access
```

### 3. Use Docker Secrets (Production)

Replace `.env` with Docker secrets:

```yaml
services:
  app:
    secrets:
      - anthropic_api_key
    environment:
      ANTHROPIC_API_KEY_FILE: /run/secrets/anthropic_api_key

secrets:
  anthropic_api_key:
    external: true
```

### 4. Enable HTTPS

Use a reverse proxy (nginx, Traefik, Caddy) with SSL certificates:

```yaml
services:
  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
```

---

## Backup and Restore

### Backup Database

```bash
# Create backup
docker-compose exec -T postgres pg_dump -U asyncagent async_agent > backup.sql

# Or use compressed backup
docker-compose exec -T postgres pg_dump -U asyncagent async_agent | gzip > backup.sql.gz
```

### Restore Database

```bash
# From SQL file
docker-compose exec -T postgres psql -U asyncagent async_agent < backup.sql

# From compressed backup
gunzip < backup.sql.gz | docker-compose exec -T postgres psql -U asyncagent async_agent
```

### Backup Files

```bash
# Backup file storage
docker run --rm \
  -v async-agent_file_storage:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/files-backup.tar.gz -C /data .
```

---

## Production Deployment

### Recommended Stack

```
Internet â†’ Caddy/Nginx (HTTPS) â†’ Docker Network â†’ Async Agent
                                â†“
                          PostgreSQL (persistent)
```

### Environment-Specific Configs

```bash
# Production
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# Staging
docker-compose -f docker-compose.yml -f docker-compose.staging.yml up -d
```

### Monitoring

Add monitoring stack:

```bash
# Add to docker-compose.yml
services:
  prometheus:
    image: prom/prometheus
    # ... config

  grafana:
    image: grafana/grafana
    # ... config
```

---

## Development with Docker

### Hot Reload Development

```bash
# Use development override
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

# Or mount source code for live editing
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
```

Create `docker-compose.dev.yml`:

```yaml
version: '3.8'
services:
  app:
    build:
      target: builder  # Use builder stage for dev tools
    volumes:
      - ./src:/app/src
      - ./prisma:/app/prisma
    command: npm run dev
    environment:
      NODE_ENV: development
```

---

## Support

For issues or questions:

1. Check logs: `docker-compose logs -f`
2. Verify health: `curl localhost:3001/health`
3. Review configuration: `cat .env`
4. Consult main README.md for API documentation

---

## Quick Reference

```bash
# One-command setup
cp .env.docker.example .env && \
  nano .env && \
  docker-compose up -d

# One-command test
curl -X POST localhost:3001/webhook \
  -H "Content-Type: application/json" \
  -d '{"prompt":"Hello!","requestId":"test"}'

# One-command cleanup
docker-compose down -v
```

---

**Ready to deploy? Start with:** `docker-compose up -d` ğŸš€
